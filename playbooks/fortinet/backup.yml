---

- name: Firewalls Fortinet rules
  hosts: fortinet
  connection: httpapi
  gather_facts: no
  tasks:
  - include_vars: ../../defaults/main.yml

  #https://github.com/fortinet-ansible-dev/ansible-galaxy-fortios-collection/issues/186
  - name: Backup a Fortigate FW
    fortinet.fortios.fortios_monitor:
      vdom: "{{ fw_fg_vdom }}"
      access_token: "{{ fw_access_token }}"
      selector: 'backup.system.config'
      params:
        scope: 'global'
    register: backupinfo
  
  - name: Debug backup content
    debug:
      var: backupinfo

  - name: Save the backup information to a file
    copy:
      content: '{{ backupinfo.meta.raw }}'
      dest: "/tmp/backup"


- name: Store files via scp
  hosts: backup-server
  connection: ssh
  tasks:
  - include_vars: ../../defaults/main.yml

  - debug:
      msg: "{{ '%Y-%m-%dT%H:%M:%S' | strftime(ansible_date_time.epoch) }}"

  - name: Create backup folder on backup server
    ansible.builtin.file:
      path: "{{ backup_server_folder }}"
      state: directory
    become: true
    vars:
      ansible_user: "{{ backup_server_user }}"
      ansible_ssh_pass: "{{ backup_server_pass }}"

  - name: Copy config to backup server
    copy:
      src: "/tmp/backup"
      dest: "{{ backup_server_folder }}backup-fortinet-{{ now () }}"
    become: true
    vars:
      ansible_user: "{{ backup_server_user }}"
      ansible_ssh_pass: "{{ backup_server_pass }}"

